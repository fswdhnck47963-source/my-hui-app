<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Hui - æƒ…ä¾£ä¸“å±åº”ç”¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeanCloud SDK - ä¸»CDN -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js" 
            onerror="loadBackupScript()"></script>
    <!-- å¤‡ç”¨CDN -->
    <script>
        function loadBackupScript() {
            console.log('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/leancloud-storage@4.13.2/dist/av-min.js';
            script.onerror = function() {
                console.error('æ‰€æœ‰CDNéƒ½æ— æ³•åŠ è½½LeanCloud SDK');
                document.getElementById('loading-view').innerHTML = `
                    <div class="max-w-md mx-auto text-center">
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <strong class="font-bold">ç½‘ç»œé”™è¯¯ï¼</strong>
                            <span class="block mt-2">æ— æ³•åŠ è½½å¿…è¦çš„ç»„ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢ã€‚</span>
                            <button onclick="location.reload()" class="bg-red-500 text-white px-4 py-2 rounded mt-3 hover:bg-red-600">
                                é‡æ–°åŠ è½½
                            </button>
                        </div>
                    </div>
                `;
            };
            document.head.appendChild(script);
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f9fafb; }
        .font-artistic { font-family: 'Pacifico', cursive; }
        .view { display: none; }
        .view.active { display: block; }
        .form-switch-link { color: #ec4899; cursor: pointer; }
        .form-switch-link:hover { text-decoration: underline; }
        .todo-item:hover .delete-btn { opacity: 1; }
        .anniversary-card:hover .delete-anniversary-btn { opacity: 1; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .segmented-control { display: flex; padding: 4px; background-color: #e5e7eb; border-radius: 0.75rem; }
        .segmented-control .tab-button { flex: 1; padding: 8px 0; border-radius: 0.5rem; font-weight: 500; color: #4b5563; transition: all 0.2s ease-in-out; }
        .segmented-control .tab-button.active { background-color: white; color: #1f2937; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .input-with-icon { position: relative; }
        .input-with-icon svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .input-with-icon input { padding-left: 2.5rem; }
        .gradient-bg { background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="min-h-screen">
        <!-- åŠ è½½é¡µé¢ -->
        <div id="loading-view" class="view active text-center mt-20 p-4">
            <div class="max-w-md mx-auto">
                <div class="gradient-bg text-white p-8 rounded-2xl shadow-lg">
                    <h1 class="font-artistic text-4xl mb-4">My Hui</h1>
                    <p class="text-pink-100">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</p>
                    <div class="mt-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç™»å½•æ³¨å†Œé¡µé¢ -->
        <div id="auth-view" class="view">
            <div class="flex min-h-screen">
                <div class="hidden md:flex md:w-1/2 gradient-bg items-center justify-center p-12 text-white text-center">
                    <div>
                        <h1 class="font-artistic text-7xl leading-tight">My Hui</h1>
                        <p class="mt-4 text-lg opacity-80">å±äºä½ ä»¬çš„ç§å¯†ç©ºé—´</p>
                        <div class="mt-8 space-y-2 text-left max-w-sm">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span>å…±äº«å¾…åŠæ¸…å•</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span>çºªå¿µæ—¥æé†’</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span>å®æ—¶åŒæ­¥</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-1/2 flex items-center justify-center p-6 sm:p-12 bg-white">
                    <div class="w-full max-w-md">
                        <h1 class="font-artistic text-5xl text-pink-500 mb-4 text-center md:hidden">My Hui</h1>
                        
                        <!-- ç™»å½•è¡¨å• -->
                        <form id="login-form" class="space-y-4">
                            <h2 class="text-2xl font-bold text-gray-800">æ¬¢è¿å›æ¥</h2>
                            <p class="text-gray-500">è¯·ç™»å½•ä»¥ç»§ç»­</p>
                            <div class="input-with-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.803V4.697l-5.803 3.558Z"/>
                                </svg>
                                <input type="email" id="login-email" required placeholder="é‚®ç®±" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                            </div>
                            <div class="input-with-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1z"/>
                                </svg>
                                <input type="password" id="login-password" required placeholder="å¯†ç " class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                            </div>
                            <button type="submit" id="login-btn" class="w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition shadow-md">
                                ç™»å½•
                            </button>
                            <p class="text-center text-sm text-gray-600">
                                è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ 
                                <span id="show-register-link" class="form-switch-link">ç«‹å³æ³¨å†Œ</span>
                            </p>
                        </form>

                        <!-- æ³¨å†Œè¡¨å• -->
                        <form id="register-form" class="hidden space-y-4">
                            <h2 class="text-2xl font-bold text-gray-800">åˆ›å»ºè´¦æˆ·</h2>
                            <p class="text-gray-500">å¼€å¯ä½ ä»¬çš„ä¸“å±ç©ºé—´</p>
                            <div class="input-with-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.803V4.697l-5.803 3.558Z"/>
                                </svg>
                                <input type="email" id="register-email" required placeholder="é‚®ç®±" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                            </div>
                            <div class="input-with-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1z"/>
                                </svg>
                                <input type="password" id="register-password" required minlength="6" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                            </div>
                            <button type="submit" id="register-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition shadow-md">
                                æ³¨å†Œ
                            </button>
                            <p class="text-center text-sm text-gray-600">
                                å·²æœ‰è´¦æˆ·ï¼Ÿ 
                                <span id="show-login-link" class="form-switch-link">è¿”å›ç™»å½•</span>
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»‘å®šä¼´ä¾£é¡µé¢ -->
        <div id="partner-view" class="view p-4">
            <div class="max-w-md mx-auto text-center bg-white p-8 rounded-2xl shadow-sm mt-10 sm:mt-20">
                <div class="gradient-bg text-white p-6 rounded-xl mb-6">
                    <h1 class="text-2xl font-bold mb-2">è¿˜å·®ä¸€æ­¥</h1>
                    <p class="text-pink-100">ç»‘å®šä¼´ä¾£åå³å¯å¼€å§‹ä½¿ç”¨</p>
                </div>
                <p id="user-email-display" class="text-gray-500 mb-6">å·²ç™»å½•: </p>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-left">
                    <h3 class="font-semibold text-blue-800 mb-2">ç»‘å®šè¯´æ˜</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>â€¢ è¾“å…¥ä¼´ä¾£çš„æ³¨å†Œé‚®ç®±å‘é€ç»‘å®šè¯·æ±‚</li>
                        <li>â€¢ å¯¹æ–¹ç™»å½•æ—¶ä¼šæ”¶åˆ°ç¡®è®¤æç¤º</li>
                        <li>â€¢ åŒæ–¹éƒ½åŒæ„åå³å¯å¼€å§‹ä½¿ç”¨</li>
                        <li>â€¢ å¦‚æœå¯¹æ–¹å·²å‘æ‚¨å‘é€è¯·æ±‚ï¼Œè¾“å…¥å¯¹æ–¹é‚®ç®±å³å¯ç›´æ¥ç»‘å®š</li>
                    </ul>
                </div>
                
                <div class="mb-6 text-left">
                    <label for="partner-email-input" class="block text-sm font-medium text-gray-700 mb-1">
                        è¯·è¾“å…¥ä¼´ä¾£çš„æ³¨å†Œé‚®ç®±
                    </label>
                    <input type="email" id="partner-email-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="partner@example.com">
                </div>
                <button id="connect-partner-btn" class="w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition shadow-md">
                    å‘é€ç»‘å®šè¯·æ±‚
                </button>
                
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <button id="check-requests-btn" class="text-sm text-blue-500 hover:text-blue-700 mb-2">
                        æ£€æŸ¥å¾…å¤„ç†çš„ç»‘å®šè¯·æ±‚
                    </button>
                    <br>
                    <button id="logout-btn-partner-view" class="text-sm text-gray-500 hover:text-red-500">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸»åº”ç”¨é¡µé¢ -->
        <div id="main-app-view" class="view">
            <header class="sticky top-0 z-10 bg-white/90 backdrop-blur-lg border-b border-gray-200/80 shadow-sm">
                <div class="container mx-auto max-w-4xl p-4 flex justify-between items-center">
                    <h1 class="font-artistic text-3xl text-pink-500">My Hui</h1>
                    <div class="flex items-center space-x-4">
                        <span id="main-user-email" class="hidden sm:inline text-sm text-gray-500"></span>
                        <span id="partner-info" class="hidden sm:inline text-xs text-gray-400"></span>
                        <button id="logout-btn-main-view" class="text-sm text-gray-500 hover:text-red-500">
                            é€€å‡ºç™»å½•
                        </button>
                    </div>
                </div>
            </header>

            <main class="p-4">
                <div class="max-w-2xl mx-auto">
                    <div class="segmented-control mb-6">
                        <button id="tab-todos" class="tab-button active">å…±äº«æ¸…å•</button>
                        <button id="tab-anniversaries" class="tab-button">çºªå¿µæ—¥</button>
                    </div>
                </div>

                <div id="content-todos"></div>
                <div id="content-anniversaries" class="hidden"></div>
            </main>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="toast-message" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>
    </div>

    <script>
        // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        window.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥è®¿é—®åè®®
            if (window.location.protocol === 'file:') {
                document.getElementById('loading-view').innerHTML = `
                    <div class="max-w-md mx-auto text-center">
                        <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-6 py-4 rounded-lg">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <strong class="font-bold">è®¿é—®æ–¹å¼é”™è¯¯</strong>
                            </div>
                            <p class="mb-4">æ‚¨æ­£åœ¨ä½¿ç”¨file://åè®®è®¿é—®ï¼Œè¿™ä¼šå¯¼è‡´è·¨åŸŸé”™è¯¯ã€‚</p>
                            <div class="bg-white p-4 rounded border text-left text-sm">
                                <p class="font-semibold mb-2">è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
                                <ol class="list-decimal list-inside space-y-1">
                                    <li>æ‰“å¼€å‘½ä»¤æç¤ºç¬¦æˆ–Anaconda Prompt</li>
                                    <li>è¾“å…¥ï¼š<code class="bg-gray-200 px-1 rounded">F:</code></li>
                                    <li>è¾“å…¥ï¼š<code class="bg-gray-200 px-1 rounded">cd MyHui\\public</code></li>
                                    <li>è¾“å…¥ï¼š<code class="bg-gray-200 px-1 rounded">python -m http.server 8000</code></li>
                                    <li>åœ¨æµè§ˆå™¨è®¿é—®ï¼š<code class="bg-gray-200 px-1 rounded">http://localhost:8000</code></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºå½“å‰è®¿é—®ä¿¡æ¯
            console.log('è®¿é—®åè®®:', window.location.protocol);
            console.log('è®¿é—®åœ°å€:', window.location.href);
            console.log('Origin:', window.location.origin);
            // æ£€æŸ¥AVæ˜¯å¦å·²åŠ è½½
            if (typeof AV === 'undefined') {
                console.error('LeanCloud SDKæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                document.getElementById('loading-view').innerHTML = `
                    <div class="max-w-md mx-auto text-center">
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <strong class="font-bold">åŠ è½½å¤±è´¥ï¼</strong>
                            <span class="block sm:inline">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</span>
                        </div>
                    </div>
                `;
                return;
            }

            // --- åˆå§‹åŒ– LeanCloud ---
            try {
                AV.init({
                    appId: "jrJXnuJG3a5nR1dilUv27qLp-gzGzoHsz",
                    appKey: "zQYmxLdBHvwjIxfghNB3NufV",
                    serverURL: "https://jrjxnujg.lc-cn-n1-shared.com"
                });
                console.log('LeanCloud åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('LeanCloud åˆå§‹åŒ–å¤±è´¥:', error);
                return;
            }

        // --- å…¨å±€å˜é‡ ---
        const views = { 
            loading: document.getElementById('loading-view'), 
            auth: document.getElementById('auth-view'), 
            partner: document.getElementById('partner-view'), 
            main: document.getElementById('main-app-view') 
        };
        const contentTodos = document.getElementById('content-todos');
        const contentAnniversaries = document.getElementById('content-anniversaries');
        let sharedDataObject = null;
        let syncInterval = null; // æ›¿æ¢liveQuery

        // --- è¾…åŠ©å‡½æ•° ---
        function switchView(viewName) { 
            Object.values(views).forEach(v => v.classList.remove('active')); 
            if(views[viewName]) views[viewName].classList.add('active'); 
        }

        function showToast(message, isError = false) { 
            const toast = document.getElementById('toast-message'); 
            toast.textContent = message; 
            toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e'; 
            toast.style.opacity = '1'; 
            setTimeout(() => { toast.style.opacity = '0'; }, 3000); 
        }

        function escapeHtml(unsafe) { 
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); 
        }

        // --- ç»‘å®šä¼´ä¾£åŠŸèƒ½ï¼ˆå®Œå…¨ä¸ä¿®æ”¹ç”¨æˆ·è¡¨ï¼‰ ---
        async function bindPartnerDirectly(partnerEmail) {
            const currentUser = AV.User.current();
            
            if (!currentUser) {
                throw new Error('è¯·å…ˆç™»å½•ï¼');
            }
            if (!partnerEmail) {
                throw new Error('è¯·è¾“å…¥ä¼´ä¾£çš„é‚®ç®±');
            }
            if (partnerEmail === currentUser.get('email')) {
                throw new Error('ä¸èƒ½ç»‘å®šè‡ªå·±å“¦ï¼');
            }

            // æŸ¥æ‰¾ä¼´ä¾£ç”¨æˆ·
            const userQuery = new AV.Query('_User');
            userQuery.equalTo('email', partnerEmail);
            const partner = await userQuery.first();

            if (!partner) {
                throw new Error('æ‰¾ä¸åˆ°è¯¥ç”¨æˆ·ï¼Œè¯·ç¡®è®¤é‚®ç®±æ˜¯å¦æ­£ç¡®');
            }

            const PartnerRequest = AV.Object.extend('PartnerRequest');
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç»‘å®š
            const currentUserBindQuery = new AV.Query(PartnerRequest);
            currentUserBindQuery.equalTo('fromUser', currentUser);
            currentUserBindQuery.equalTo('status', 'accepted');
            const currentUserBound = await currentUserBindQuery.first();
            
            if (currentUserBound) {
                throw new Error('æ‚¨å·²ç»ç»‘å®šäº†ä¼´ä¾£ï¼');
            }

            // æ£€æŸ¥å¯¹æ–¹æ˜¯å¦å·²ç»ç»‘å®šäº†å…¶ä»–äºº
            const partnerBindQuery = new AV.Query(PartnerRequest);
            partnerBindQuery.equalTo('fromUser', partner);
            partnerBindQuery.equalTo('status', 'accepted');
            const partnerBound = await partnerBindQuery.first();
            
            if (partnerBound) {
                throw new Error('è¯¥ç”¨æˆ·å·²ç»ç»‘å®šäº†å¦ä¸€åŠå•¦ï¼');
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç»‘å®šè¯·æ±‚
            const existingQuery = new AV.Query(PartnerRequest);
            existingQuery.equalTo('fromUser', currentUser);
            existingQuery.equalTo('toUser', partner);
            existingQuery.equalTo('status', 'pending');
            const existing = await existingQuery.first();
            
            if (existing) {
                throw new Error('å·²ç»å‘è¯¥ç”¨æˆ·å‘é€è¿‡ç»‘å®šè¯·æ±‚ï¼Œè¯·ç­‰å¾…å¯¹æ–¹ç¡®è®¤');
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹æ–¹å‘æ¥çš„è¯·æ±‚
            const incomingQuery = new AV.Query(PartnerRequest);
            incomingQuery.equalTo('fromUser', partner);
            incomingQuery.equalTo('toUser', currentUser);
            incomingQuery.equalTo('status', 'pending');
            const incoming = await incomingQuery.first();

            if (incoming) {
                // æœ‰å¯¹æ–¹çš„è¯·æ±‚ï¼Œæ¥å—ç»‘å®š
                try {
                    // æ›´æ–°å¯¹æ–¹çš„è¯·æ±‚çŠ¶æ€ä¸ºå·²æ¥å—
                    incoming.set('status', 'accepted');
                    await incoming.save();
                    
                    // åˆ›å»ºå½“å‰ç”¨æˆ·çš„æ¥å—è®°å½•
                    const acceptRecord = new PartnerRequest();
                    acceptRecord.set('fromUser', currentUser);
                    acceptRecord.set('toUser', partner);
                    acceptRecord.set('status', 'accepted');
                    acceptRecord.set('fromEmail', currentUser.get('email'));
                    acceptRecord.set('toEmail', partnerEmail);
                    acceptRecord.set('bindTime', new Date());
                    
                    const acl = new AV.ACL();
                    acl.setReadAccess(currentUser, true);
                    acl.setWriteAccess(currentUser, true);
                    acl.setReadAccess(partner, true);
                    acceptRecord.setACL(acl);
                    
                    await acceptRecord.save();
                    
                    return { success: true, message: 'ç»‘å®šæˆåŠŸï¼æ‚¨æ¥å—äº†å¯¹æ–¹çš„ç»‘å®šè¯·æ±‚ã€‚' };
                } catch (error) {
                    console.error('ç»‘å®šè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                    throw new Error('ç»‘å®šè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
                }
            } else {
                // åˆ›å»ºæ–°çš„ç»‘å®šè¯·æ±‚
                const request = new PartnerRequest();
                request.set('fromUser', currentUser);
                request.set('toUser', partner);
                request.set('status', 'pending');
                request.set('fromEmail', currentUser.get('email'));
                request.set('toEmail', partnerEmail);
                request.set('requestTime', new Date());
                
                // è®¾ç½®ACLæƒé™
                const acl = new AV.ACL();
                acl.setReadAccess(currentUser, true);
                acl.setWriteAccess(currentUser, true);
                acl.setReadAccess(partner, true);
                acl.setWriteAccess(partner, true);
                request.setACL(acl);
                
                await request.save();
                
                throw new Error('ç»‘å®šè¯·æ±‚å·²å‘é€ï¼è¯·è®©å¯¹æ–¹ä¹Ÿè¾“å…¥æ‚¨çš„é‚®ç®±æ¥å®Œæˆç»‘å®šã€‚');
            }
        }

        // --- æ£€æŸ¥å¾…å¤„ç†çš„ç»‘å®šè¯·æ±‚ ---
        async function checkPendingRequests() {
            const currentUser = AV.User.current();
            if (!currentUser) return;

            try {
                const PartnerRequest = AV.Object.extend('PartnerRequest');
                const query = new AV.Query(PartnerRequest);
                query.equalTo('toUser', currentUser);
                query.equalTo('status', 'pending');
                query.include('fromUser');
                query.descending('createdAt');
                
                const requests = await query.find();
                
                if (requests.length > 0) {
                    const request = requests[0];
                    const fromUser = request.get('fromUser');
                    const fromEmail = request.get('fromEmail') || fromUser.get('email');
                    
                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    const shouldBind = confirm(`${fromEmail} æƒ³è¦ä¸æ‚¨ç»‘å®šä¸ºä¼´ä¾£ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"åŒæ„ç»‘å®š\nç‚¹å‡»"å–æ¶ˆ"æ‹’ç»ç»‘å®š`);
                    
                    if (shouldBind) {
                        try {
                            // æ›´æ–°è¯·æ±‚çŠ¶æ€
                            request.set('status', 'accepted');
                            request.set('acceptTime', new Date());
                            await request.save();
                            
                            // åˆ›å»ºåå‘çš„æ¥å—è®°å½•
                            const reverseRequest = new PartnerRequest();
                            reverseRequest.set('fromUser', currentUser);
                            reverseRequest.set('toUser', fromUser);
                            reverseRequest.set('status', 'accepted');
                            reverseRequest.set('fromEmail', currentUser.get('email'));
                            reverseRequest.set('toEmail', fromEmail);
                            reverseRequest.set('bindTime', new Date());
                            
                            const acl = new AV.ACL();
                            acl.setReadAccess(currentUser, true);
                            acl.setWriteAccess(currentUser, true);
                            acl.setReadAccess(fromUser, true);
                            reverseRequest.setACL(acl);
                            
                            await reverseRequest.save();
                            
                            showToast('ç»‘å®šæˆåŠŸï¼');
                            await handleUserSession(currentUser);
                        } catch (error) {
                            console.error('ç»‘å®šå¤±è´¥:', error);
                            showToast(`ç»‘å®šå¤±è´¥: ${error.message}`, true);
                        }
                    } else {
                        // æ‹’ç»è¯·æ±‚
                        try {
                            request.set('status', 'rejected');
                            request.set('rejectTime', new Date());
                            await request.save();
                            showToast('å·²æ‹’ç»ç»‘å®šè¯·æ±‚');
                        } catch (error) {
                            console.error('æ‹’ç»è¯·æ±‚å¤±è´¥:', error);
                        }
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç»‘å®šè¯·æ±‚å¤±è´¥:', error);
            }
        }

        // --- é€šè¿‡PartnerRequestè¡¨è·å–ä¼´ä¾£ä¿¡æ¯ ---
        async function getPartnerFromRequests(user) {
            try {
                const PartnerRequest = AV.Object.extend('PartnerRequest');
                
                // æŸ¥æ‰¾å½“å‰ç”¨æˆ·ä½œä¸ºå‘èµ·è€…çš„å·²æ¥å—è¯·æ±‚
                const query1 = new AV.Query(PartnerRequest);
                query1.equalTo('fromUser', user);
                query1.equalTo('status', 'accepted');
                query1.include('toUser');
                
                // æŸ¥æ‰¾å½“å‰ç”¨æˆ·ä½œä¸ºæ¥æ”¶è€…çš„å·²æ¥å—è¯·æ±‚
                const query2 = new AV.Query(PartnerRequest);
                query2.equalTo('toUser', user);
                query2.equalTo('status', 'accepted');
                query2.include('fromUser');
                
                const mainQuery = AV.Query.or(query1, query2);
                const request = await mainQuery.first();
                
                if (request) {
                    // åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å‘èµ·è€…è¿˜æ˜¯æ¥æ”¶è€…ï¼Œè¿”å›å¯¹åº”çš„ä¼´ä¾£
                    const fromUser = request.get('fromUser');
                    const toUser = request.get('toUser');
                    
                    if (fromUser.id === user.id) {
                        return toUser;
                    } else {
                        return fromUser;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('è·å–ä¼´ä¾£ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }

        // --- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰ä¼´ä¾£ï¼ˆä»…é€šè¿‡PartnerRequestè¡¨ï¼‰ ---
        async function checkUserPartnerStatus(user) {
            return await getPartnerFromRequests(user);
        }

        // --- ç”¨æˆ·ä¼šè¯å¤„ç† ---
        async function handleUserSession(user) {
            // æ¸…é™¤ä¹‹å‰çš„åŒæ­¥å®šæ—¶å™¨
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            if (user) {
                try {
                    await user.fetch();
                    
                    // ä½¿ç”¨æ–°çš„æ–¹æ³•æ£€æŸ¥ä¼´ä¾£çŠ¶æ€
                    const partner = await checkUserPartnerStatus(user);
                    
                    if (partner) {
                        await partner.fetch();
                        const sharedDocId = [user.id, partner.id].sort().join('-');
                        await setupSharedData(sharedDocId);
                        
                        document.getElementById('main-user-email').textContent = user.get('email');
                        document.getElementById('partner-info').textContent = `â™¥ ${partner.get('email')}`;
                        switchView('main');
                        
                        // å¯åŠ¨å®šæœŸåŒæ­¥ï¼ˆæ¯10ç§’åŒæ­¥ä¸€æ¬¡ï¼‰
                        syncInterval = setInterval(async () => {
                            try {
                                await refreshSharedData(sharedDocId);
                            } catch (error) {
                                console.error('åŒæ­¥æ•°æ®å¤±è´¥:', error);
                            }
                        }, 10000);
                    } else {
                        document.getElementById('user-email-display').textContent = `å·²ç™»å½•: ${user.get('email')}`;
                        switchView('partner');
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ç»‘å®šè¯·æ±‚
                        setTimeout(() => {
                            checkPendingRequests();
                        }, 1000);
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    showToast(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`, true);
                    await AV.User.logOut();
                    switchView('auth');
                }
            } else {
                switchView('auth');
            }
        }
        
        // --- å…±äº«æ•°æ®ç®¡ç†ï¼ˆä¸ä½¿ç”¨LiveQueryï¼‰ ---
        async function setupSharedData(sharedDocId) {
            const query = new AV.Query('SharedData');
            query.equalTo('sharedId', sharedDocId);
            let sharedDoc = await query.first();
            
            if (!sharedDoc) {
                const SharedData = AV.Object.extend('SharedData');
                sharedDoc = new SharedData();
                sharedDoc.set('sharedId', sharedDocId);
                sharedDoc.set('todos', []);
                sharedDoc.set('anniversaries', []);
                
                // è®¾ç½®ACLæƒé™
                const acl = new AV.ACL();
                const currentUser = AV.User.current();
                const partner = await getPartnerFromRequests(currentUser);
                
                if (partner) {
                    acl.setReadAccess(currentUser, true);
                    acl.setWriteAccess(currentUser, true);
                    acl.setReadAccess(partner, true);
                    acl.setWriteAccess(partner, true);
                    sharedDoc.setACL(acl);
                }
                
                await sharedDoc.save();
            }
            
            sharedDataObject = sharedDoc;
            renderAll(sharedDataObject.attributes);
        }

        // --- åˆ·æ–°å…±äº«æ•°æ® ---
        async function refreshSharedData(sharedDocId) {
            if (!sharedDataObject) return;
            
            try {
                const query = new AV.Query('SharedData');
                query.equalTo('sharedId', sharedDocId);
                const updatedDoc = await query.first();
                
                if (updatedDoc && updatedDoc.updatedAt > sharedDataObject.updatedAt) {
                    sharedDataObject = updatedDoc;
                    renderAll(updatedDoc.attributes);
                    console.log('æ•°æ®å·²åŒæ­¥');
                }
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
            }
        }

        // --- æ‰‹åŠ¨åˆ·æ–°æŒ‰é’® ---
        function addRefreshButton() {
            const header = document.querySelector('#main-app-view header .container');
            if (header && !document.getElementById('refresh-btn')) {
                const refreshBtn = document.createElement('button');
                refreshBtn.id = 'refresh-btn';
                refreshBtn.className = 'text-sm text-gray-500 hover:text-pink-500 mr-2';
                refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°';
                refreshBtn.title = 'æ‰‹åŠ¨åŒæ­¥æ•°æ®';
                
                refreshBtn.addEventListener('click', async () => {
                    refreshBtn.textContent = 'åŒæ­¥ä¸­...';
                    refreshBtn.disabled = true;
                    
                    try {
                        const currentUser = AV.User.current();
                        const partner = await getPartnerFromRequests(currentUser);
                        if (partner) {
                            const sharedDocId = [currentUser.id, partner.id].sort().join('-');
                            await refreshSharedData(sharedDocId);
                            showToast('æ•°æ®åŒæ­¥æˆåŠŸ');
                        }
                    } catch (error) {
                        showToast('åŒæ­¥å¤±è´¥', true);
                    } finally {
                        refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°';
                        refreshBtn.disabled = false;
                    }
                });
                
                const emailSpan = document.getElementById('main-user-email');
                header.insertBefore(refreshBtn, emailSpan);
            }
        }

        // --- æ¸²æŸ“å‡½æ•° ---
        function renderAll(data) { 
            renderTodos(data.todos || []); 
            renderAnniversaries(data.anniversaries || []); 
        }

        function renderTodos(todos) { 
            const pendingTodos = todos.filter(t => !t.completed).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)); 
            const completedTodos = todos.filter(t => t.completed).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)); 
            const progress = todos.length > 0 ? (completedTodos.length / todos.length) * 100 : 0; 
            
            contentTodos.innerHTML = `
                <div class="space-y-6 max-w-2xl mx-auto">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-gray-700">ä»»åŠ¡è¿›åº¦</h3>
                            <span class="text-sm font-medium text-pink-500">${completedTodos.length} / ${todos.length}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="gradient-bg h-3 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                        ${progress === 100 && todos.length > 0 ? '<p class="text-center text-pink-500 font-medium mt-2">ğŸ‰ æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼</p>' : ''}
                    </div>
                    
                    <form id="add-todo-form" class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex gap-3">
                            <input type="text" id="todo-input" class="flex-grow p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent" placeholder="æ·»åŠ æ–°çš„å¾…åŠäº‹é¡¹..." required>
                            <button type="submit" class="gradient-bg text-white px-6 rounded-lg hover:opacity-90 transition-all font-semibold">æ·»åŠ </button>
                        </div>
                    </form>
                    
                    <div id="pending-todos-container"></div>
                    <div id="completed-todos-container"></div>
                </div>
            `; 
            
            const pendingContainer = document.getElementById('pending-todos-container'); 
            if(pendingTodos.length > 0) { 
                pendingContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <h3 class="font-semibold text-gray-800 p-4 border-b border-gray-100">å¾…åŠäº‹é¡¹ (${pendingTodos.length})</h3>
                        <ul class="divide-y divide-gray-100">
                            ${pendingTodos.map(renderTodoItem).join('')}
                        </ul>
                    </div>
                `; 
            } 
            
            const completedContainer = document.getElementById('completed-todos-container'); 
            if(completedTodos.length > 0) { 
                completedContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <h3 class="font-semibold text-gray-800 p-4 border-b border-gray-100">å·²å®Œæˆ (${completedTodos.length})</h3>
                        <ul class="divide-y divide-gray-100">
                            ${completedTodos.map(renderTodoItem).join('')}
                        </ul>
                    </div>
                `; 
            } 
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('add-todo-form').addEventListener('submit', handleAddTodo); 
            document.querySelectorAll('input[type="checkbox"]').forEach(el => el.addEventListener('change', handleToggleTodo)); 
            document.querySelectorAll('.delete-btn').forEach(el => el.addEventListener('click', handleDeleteTodo)); 
        }

        function renderTodoItem(todo) { 
            const createdAt = new Date(todo.createdAt).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' }); 
            return `
                <li class="todo-item flex items-center p-4 transition-colors hover:bg-gray-50">
                    <input type="checkbox" data-id="${todo.id}" class="h-5 w-5 rounded border-gray-300 text-pink-500 focus:ring-pink-500 cursor-pointer" ${todo.completed ? 'checked' : ''}>
                    <div class="ml-4 flex-grow">
                        <span class="text-gray-800 ${todo.completed ? 'line-through text-gray-400' : ''}">${escapeHtml(todo.text)}</span>
                        <p class="text-xs text-gray-400 mt-1">${createdAt} åˆ›å»º</p>
                    </div>
                    <button data-id="${todo.id}" class="delete-btn ml-auto text-gray-400 hover:text-red-500 opacity-0 transition-all p-2 rounded-full hover:bg-red-50">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </li>
            `; 
        }

        function renderAnniversaries(anniversaries) { 
            const today = new Date(); 
            today.setHours(0,0,0,0); 
            const upcomingAnni = anniversaries.filter(a => new Date(a.date) >= today).sort((a,b) => new Date(a.date) - new Date(b.date)); 
            const pastAnni = anniversaries.filter(a => new Date(a.date) < today).sort((a,b) => new Date(b.date) - new Date(a.date)); 
            
            contentAnniversaries.innerHTML = `
                <div class="space-y-8 max-w-4xl mx-auto">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-semibold mb-4 text-gray-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            æ·»åŠ æ–°çš„çºªå¿µæ—¥
                        </h3>
                        <form id="add-anniversary-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                            <div class="sm:col-span-2">
                                <label for="anniversary-title" class="block text-sm font-medium text-gray-600 mb-1">æ ‡é¢˜</label>
                                <input type="text" id="anniversary-title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»¬çš„çºªå¿µæ—¥" required>
                            </div>
                            <div>
                                <label for="anniversary-date" class="block text-sm font-medium text-gray-600 mb-1">æ—¥æœŸ</label>
                                <input type="date" id="anniversary-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" required>
                            </div>
                            <button type="submit" class="sm:col-span-3 w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors font-semibold">
                                æ·»åŠ çºªå¿µæ—¥
                            </button>
                        </form>
                    </div>
                    
                    <div id="upcoming-anniversaries-container"></div>
                    <div id="past-anniversaries-container"></div>
                </div>
            `; 
            
            const upcomingContainer = document.getElementById('upcoming-anniversaries-container'); 
            if(upcomingAnni.length > 0) { 
                upcomingContainer.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-4 text-xl flex items-center">
                            <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2L13.09 8.26L20 9L15 13.74L16.18 20.02L10 16.77L3.82 20.02L5 13.74L0 9L6.91 8.26L10 2Z" clip-rule="evenodd"></path>
                            </svg>
                            å³å°†åˆ°æ¥ (${upcomingAnni.length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${upcomingAnni.map(renderAnniversaryCard).join('')}
                        </div>
                    </div>
                `; 
            } 
            
            const pastContainer = document.getElementById('past-anniversaries-container'); 
            if(pastAnni.length > 0) { 
                pastContainer.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-4 text-xl flex items-center">
                            <svg class="w-6 h-6 mr-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            å·²ç»å† (${pastAnni.length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${pastAnni.map(renderAnniversaryCard).join('')}
                        </div>
                    </div>
                `; 
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('add-anniversary-form').addEventListener('submit', handleAddAnniversary); 
            document.querySelectorAll('.delete-anniversary-btn').forEach(btn => btn.addEventListener('click', handleDeleteAnniversary)); 
        }

        function renderAnniversaryCard(ann) { 
            const date = new Date(ann.date); 
            const today = new Date(); 
            today.setHours(0,0,0,0); 
            const daysDiff = Math.ceil((date - today) / (1000 * 60 * 60 * 24)); 
            
            let diffText, colorClass, bgClass; 
            if (daysDiff > 0) { 
                diffText = `è¿˜æœ‰ <span class="font-bold text-2xl">${daysDiff}</span> å¤©`; 
                colorClass = 'text-pink-500'; 
                bgClass = 'bg-pink-50 border-pink-200';
            } else if (daysDiff === 0) { 
                diffText = `<span class="font-bold text-2xl">ä»Šå¤©!</span>`; 
                colorClass = 'text-yellow-600'; 
                bgClass = 'bg-yellow-50 border-yellow-200';
            } else { 
                diffText = `å·²è¿‡ <span class="font-bold">${-daysDiff}</span> å¤©`; 
                colorClass = 'text-gray-500'; 
                bgClass = 'bg-gray-50 border-gray-200';
            } 
            
            return `
                <div class="anniversary-card ${bgClass} border-2 p-6 rounded-xl relative transition-all hover:shadow-md">
                    <button data-id="${ann.id}" class="delete-anniversary-btn absolute top-3 right-3 text-gray-300 hover:text-red-500 opacity-0 transition-all p-1 rounded-full hover:bg-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="flex items-start justify-between">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${escapeHtml(ann.title)}</h3>
                            <p class="text-gray-500 text-sm">${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥</p>
                        </div>
                        <div class="text-right ${colorClass}">
                            <p class="text-sm leading-tight">${diffText}</p>
                        </div>
                    </div>
                </div>
            `; 
        }
        
        // --- äº‹ä»¶å¤„ç†å‡½æ•° ---
        async function handleAddTodo(e) { 
            e.preventDefault(); 
            const input = document.getElementById('todo-input'); 
            if(!input.value.trim()) return; 
            
            const newTodo = { 
                id: crypto.randomUUID(), 
                text: input.value.trim(), 
                completed: false, 
                createdAt: new Date().toISOString() 
            }; 
            
            const currentTodos = sharedDataObject.get('todos') || []; 
            sharedDataObject.set('todos', [...currentTodos, newTodo]); 
            await sharedDataObject.save(); 
            input.value = ''; 
            showToast('ä»»åŠ¡æ·»åŠ æˆåŠŸï¼');
            
            // ç«‹å³åˆ·æ–°æ˜¾ç¤º
            renderAll(sharedDataObject.attributes);
        }

        async function handleToggleTodo(e) { 
            const todoId = e.target.dataset.id; 
            const currentTodos = sharedDataObject.get('todos') || []; 
            const updatedTodos = currentTodos.map(t => t.id === todoId ? {...t, completed: !t.completed} : t); 
            sharedDataObject.set('todos', updatedTodos); 
            await sharedDataObject.save(); 
            
            const todo = updatedTodos.find(t => t.id === todoId);
            showToast(todo.completed ? 'ä»»åŠ¡å®Œæˆï¼ğŸ‰' : 'ä»»åŠ¡æ ‡è®°ä¸ºæœªå®Œæˆ');
            
            // ç«‹å³åˆ·æ–°æ˜¾ç¤º
            renderAll(sharedDataObject.attributes);
        }

        async function handleDeleteTodo(e) { 
            const todoId = e.currentTarget.dataset.id; 
            if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªå¾…åŠäº‹é¡¹å—ï¼Ÿ")) { 
                const currentTodos = sharedDataObject.get('todos') || []; 
                const updatedTodos = currentTodos.filter(t => t.id !== todoId); 
                sharedDataObject.set('todos', updatedTodos); 
                await sharedDataObject.save(); 
                showToast('ä»»åŠ¡å·²åˆ é™¤');
                
                // ç«‹å³åˆ·æ–°æ˜¾ç¤º
                renderAll(sharedDataObject.attributes);
            } 
        }

        async function handleAddAnniversary(e) { 
            e.preventDefault(); 
            const titleInput = document.getElementById('anniversary-title'); 
            const dateInput = document.getElementById('anniversary-date'); 
            if(!titleInput.value.trim() || !dateInput.value) return; 
            
            const newAnniversary = { 
                id: crypto.randomUUID(), 
                title: titleInput.value.trim(), 
                date: new Date(dateInput.value).toISOString() 
            }; 
            
            const currentAnnis = sharedDataObject.get('anniversaries') || []; 
            sharedDataObject.set('anniversaries', [...currentAnnis, newAnniversary]); 
            await sharedDataObject.save(); 
            titleInput.value = ''; 
            dateInput.value = ''; 
            showToast('çºªå¿µæ—¥æ·»åŠ æˆåŠŸï¼');
            
            // ç«‹å³åˆ·æ–°æ˜¾ç¤º
            renderAll(sharedDataObject.attributes);
        }

        async function handleDeleteAnniversary(e) { 
            const annId = e.currentTarget.dataset.id; 
            if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ")) { 
                const currentAnnis = sharedDataObject.get('anniversaries') || []; 
                const updatedAnni = currentAnnis.filter(a => a.id !== annId); 
                sharedDataObject.set('anniversaries', updatedAnni); 
                await sharedDataObject.save(); 
                showToast('çºªå¿µæ—¥å·²åˆ é™¤');
                
                // ç«‹å³åˆ·æ–°æ˜¾ç¤º
                renderAll(sharedDataObject.attributes);
            } 
        }

        // --- è®¤è¯äº‹ä»¶ç»‘å®š ---
        document.getElementById('show-register-link').addEventListener('click', () => { 
            document.getElementById('login-form').classList.add('hidden'); 
            document.getElementById('register-form').classList.remove('hidden'); 
        });

        document.getElementById('show-login-link').addEventListener('click', () => { 
            document.getElementById('register-form').classList.add('hidden'); 
            document.getElementById('login-form').classList.remove('hidden'); 
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const registerBtn = document.getElementById('register-btn');
            registerBtn.disabled = true; 
            registerBtn.textContent = 'æ³¨å†Œä¸­...';
            
            const email = document.getElementById('register-email').value; 
            const password = document.getElementById('register-password').value; 
            
            try { 
                const user = new AV.User();
                user.setUsername(email); 
                user.setEmail(email); 
                user.setPassword(password);
                await user.signUp();
                showToast('æ³¨å†ŒæˆåŠŸï¼');
                await handleUserSession(AV.User.current());
            } catch (error) { 
                console.error('æ³¨å†Œå¤±è´¥:', error);
                showToast(`æ³¨å†Œå¤±è´¥: ${error.message}`, true); 
            } finally {
                registerBtn.disabled = false; 
                registerBtn.textContent = 'æ³¨å†Œ';
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true; 
            loginBtn.textContent = 'ç™»å½•ä¸­...';
            
            const email = document.getElementById('login-email').value; 
            const password = document.getElementById('login-password').value; 
            
            try { 
                const user = await AV.User.logIn(email, password);
                showToast('ç™»å½•æˆåŠŸï¼');
                await handleUserSession(user);
            } catch (error) { 
                console.error('ç™»å½•å¤±è´¥:', error);
                showToast(`ç™»å½•å¤±è´¥: ${error.message}`, true);
            } finally {
                loginBtn.disabled = false; 
                loginBtn.textContent = 'ç™»å½•';
            }
        });
        
        // --- ç»‘å®šä¼´ä¾£ ---
        async function connectPartner() {
            const btn = document.getElementById('connect-partner-btn');
            btn.disabled = true; 
            btn.textContent = 'ç»‘å®šä¸­...';
            const partnerEmail = document.getElementById('partner-email-input').value.trim();
            
            try {
                const result = await bindPartnerDirectly(partnerEmail);
                showToast(result.message);
                await handleUserSession(AV.User.current());
            } catch(error) {
                console.error('ç»‘å®šå¤±è´¥:', error);
                showToast(`ç»‘å®šå¤±è´¥: ${error.message}`, true);
            } finally {
                btn.disabled = false; 
                btn.textContent = 'ç»‘å®šä¼´ä¾£';
            }
        }

        document.getElementById('connect-partner-btn').addEventListener('click', connectPartner);

        // æ‰‹åŠ¨æ£€æŸ¥ç»‘å®šè¯·æ±‚æŒ‰é’®
        document.getElementById('check-requests-btn').addEventListener('click', async () => {
            const btn = document.getElementById('check-requests-btn');
            btn.disabled = true;
            btn.textContent = 'æ£€æŸ¥ä¸­...';
            
            try {
                await checkPendingRequests();
            } catch (error) {
                showToast('æ£€æŸ¥è¯·æ±‚å¤±è´¥', true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ£€æŸ¥å¾…å¤„ç†çš„ç»‘å®šè¯·æ±‚';
            }
        });

        // --- é€€å‡ºç™»å½• ---
        async function handleLogout() { 
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                // æ¸…é™¤åŒæ­¥å®šæ—¶å™¨
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
                
                await AV.User.logOut(); 
                showToast('å·²é€€å‡ºç™»å½•');
                handleUserSession(null); 
            }
        }

        document.getElementById('logout-btn-partner-view').addEventListener('click', handleLogout);
        document.getElementById('logout-btn-main-view').addEventListener('click', handleLogout);

        // --- æ ‡ç­¾åˆ‡æ¢ ---
        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => { 
            tab.addEventListener('click', () => { 
                tabs.forEach(t => t.classList.remove('active')); 
                tab.classList.add('active'); 
                contentTodos.classList.toggle('hidden', tab.id !== 'tab-todos'); 
                contentAnniversaries.classList.toggle('hidden', tab.id !== 'tab-anniversaries'); 
            }); 
        });

        // --- å¯åŠ¨åº”ç”¨ ---
        setTimeout(() => {
            handleUserSession(AV.User.current());
            // å¦‚æœç”¨æˆ·å·²ç™»å½•ä¸”åœ¨ä¸»ç•Œé¢ï¼Œæ·»åŠ åˆ·æ–°æŒ‰é’®
            setTimeout(() => {
                if (views.main.classList.contains('active')) {
                    addRefreshButton();
                }
            }, 2000);
        }, 1000); // çŸ­æš‚å»¶è¿Ÿæ˜¾ç¤ºåŠ è½½æ•ˆæœ

        }); // DOMContentLoaded ç»“æŸ
    </script>
</body>
</html>